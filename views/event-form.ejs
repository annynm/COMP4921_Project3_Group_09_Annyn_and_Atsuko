<%- include('partials/header') %>
    <%- include('partials/nav', { activePage: 'events' , user: user }) %>

        <% function formatDateTimeLocal(dateStr) { if (!dateStr) return '' ; const date=new Date(dateStr); const
            pad=(n)=> n.toString().padStart(2, '0');
            return `${date.getUTCFullYear()}-${pad(date.getUTCMonth() +
            1)}-${pad(date.getUTCDate())}T${pad(date.getUTCHours())}:${pad(date.getUTCMinutes())}`;
            }
            %>

            <div class="container">
                <div class="glass-card" style="max-width: 600px; margin: 0 auto;">
                    <h1 style="color: var(--greendale-blue-dark); margin-bottom: 2rem; text-align: center;">
                        <%= pageTitle %>
                    </h1>

                    <% if (warnings && warnings.length> 0) { %>
                        <div class="warnings-container" style="margin-bottom: 2rem;">
                            <% warnings.forEach(warning=> { %>
                                <div class="warning-message"
                                    style="background: rgba(255, 152, 0, 0.1); border: 1px solid var(--warning); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--warning); font-weight: bold;">⚠️ Warning:</span>
                                        <span>
                                            <%= warning.message %>
                                        </span>
                                    </div>
                                </div>
                                <% }); %>
                        </div>
                        <% } %>

                            <form action="<%= formAction %>" method="POST" id="eventForm">
                                <div class="form-group">
                                    <label for="event_name">Event Name</label>
                                    <input type="text" id="event_name" name="event_name"
                                        value="<%= formData.event_name || '' %>" required>
                                </div>

                                <div class="form-group">
                                    <label for="event_description">Description</label>
                                    <textarea id="event_description" name="event_description"
                                        rows="4"><%= formData.event_description || '' %></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="start_datetime">Start Date & Time</label>
                                    <input type="datetime-local" id="start_datetime" name="start_datetime"
                                        value="<%= formatDateTimeLocal(formData.start_datetime) %>" required>
                                </div>

                                <div class="form-group">
                                    <label for="end_datetime">End Date & Time</label>
                                    <input type="datetime-local" id="end_datetime" name="end_datetime"
                                        value="<%= formatDateTimeLocal(formData.end_datetime) %>" required>
                                </div>

                                <!-- Hidden inputs for UTC values -->
                                <input type="hidden" id="start_datetime_utc" name="start_datetime">
                                <input type="hidden" id="end_datetime_utc" name="end_datetime">

                                <div class="form-group">
                                    <label for="recurring_type">Recurring</label>
                                    <select id="recurring_type" name="recurring_type" <%=isEditMode ? 'disabled' : ''
                                        %>>
                                        <option value="none" <%=formData.recurring_type==='none' ||
                                            !formData.recurring_type ? 'selected' : '' %>>Does not repeat</option>
                                        <option value="daily" <%=formData.recurring_type==='daily' ? 'selected' : '' %>
                                            >Everyday</option>
                                        <option value="weekly" <%=formData.recurring_type==='weekly' ? 'selected' : ''
                                            %>>Weekly</option>
                                        <option value="monthly" <%=formData.recurring_type==='monthly' ? 'selected' : ''
                                            %>>Monthly on the day</option>
                                    </select>
                                    <% if (isEditMode) { %>
                                        <p
                                            style="font-size: 0.875rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                                            Recurring settings cannot be changed after event creation.
                                        </p>
                                        <% } %>
                                </div>

                                <div class="form-group" id="recurring_end_date_group" style="display: none;">
                                    <label for="recurring_end_date">Recurring ends on (inclusive)</label>
                                    <input type="date" id="recurring_end_date" name="recurring_end_date"
                                        value="<%= formData.recurring_end_date || '' %>" <%=isEditMode ? 'disabled' : ''
                                        %>>
                                </div>

                                <div class="form-group">
                                    <label for="room_id">Room</label>
                                    <select id="room_id" name="room_id">
                                        <option value="">No Room</option>
                                        <% rooms.forEach(function(room) { %>
                                            <option value="<%= room.room_id %>" <%=formData.room_id==room.room_id
                                                ? 'selected' : '' %>>
                                                <%= room.room_name %> (Capacity: <%= room.capacity %>)
                                            </option>
                                            <% }); %>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="privacy_type">Privacy</label>
                                    <select id="privacy_type" name="privacy_type" required>
                                        <option value="public" <%=formData.privacy_type==='public' ? 'selected' : '' %>
                                            >Public
                                        </option>
                                        <option value="friends_only" <%=formData.privacy_type==='friends_only'
                                            ? 'selected' : '' %>>Friends Only</option>
                                        <option value="invite_only" <%=formData.privacy_type==='invite_only'
                                            ? 'selected' : '' %>>Invite Only</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="max_capacity">Max Capacity (leave empty for unlimited)</label>
                                    <input type="number" id="max_capacity" name="max_capacity" min="1"
                                        value="<%= formData.max_capacity || '' %>">
                                </div>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" name="allow_friend_invites"
                                            <%=formData.allow_friend_invites !==false ? 'checked' : '' %>>
                                        Allow attendees to invite friends
                                    </label>
                                </div>

                                <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                                    <label for="color">Event Display Color</label>
                                    <input type="color" id="color" name="color"
                                        value="<%= formData.color || '#4287f5' %>"
                                        style="width: 50px; height: 40px; padding: 0; border: none;">
                                </div>

                                <button type="submit" class="cta-button" style="width: 100%;" id="submitButton">
                                    <%= submitButtonText %>
                                </button>

                                <% if (warnings && warnings.length> 0) { %>
                                    <p
                                        style="text-align: center; color: var(--warning); margin-top: 1rem; font-style: italic;">
                                        Warning: Conflicts detected above. You can still proceed, but please review the
                                        conflicts.
                                    </p>
                                    <% } %>
                            </form>
                </div>
            </div>

            <!-- Day.js from CDN -->
            <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/timezone.js"></script>
            <script src="/js/dayjs-setup.js"></script>

            <script>
                // Initialize Day.js when it's ready
                function initDayJS() {
                    if (typeof dayjs === 'undefined' || typeof dayjs_plugin_utc === 'undefined' || typeof dayjs_plugin_timezone === 'undefined') {
                        setTimeout(initDayJS, 100);
                        return;
                    }

                    dayjs.extend(dayjs_plugin_utc);
                    dayjs.extend(dayjs_plugin_timezone);

                    // Get user's timezone
                    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                    // Helper function to normalize UTC string to ISO format
                    function normalizeUTCString(utcStr) {
                        if (!utcStr) return null;

                        // Convert to string if it's not already
                        let str = String(utcStr).trim();

                        // If it's already in ISO format with Z, return as-is
                        if (str.endsWith('Z') && str.includes('T')) {
                            return str;
                        }

                        // Handle various formats
                        // Replace space with T if present
                        str = str.replace(' ', 'T');

                        // Remove milliseconds if present
                        str = str.replace(/\.\d{3}$/, '');

                        // Ensure we have seconds
                        if (!str.match(/T\d{2}:\d{2}:\d{2}/)) {
                            // Add :00 for seconds if missing
                            str = str.replace(/T(\d{2}:\d{2})$/, 'T$1:00');
                        }

                        // Add Z if not present
                        if (!str.endsWith('Z')) {
                            str = str + 'Z';
                        }

                        return str;
                    }

                    // Convert UTC to local timezone for form display (edit mode)
                    <% if (isEditMode && formData.start_datetime) { %>
                    const startUTC = '<%= formData.start_datetime %>';
                        const endUTC = '<%= formData.end_datetime %>';

                        if (startUTC && endUTC) {
                            try {
                                // formatForForm returns YYYY-MM-DDTHH:mm format (UTC, no Z)
                                // We need to add Z to make it a proper UTC ISO string
                                const normalizedStart = normalizeUTCString(startUTC);
                                const normalizedEnd = normalizeUTCString(endUTC);

                                const startLocal = dayjs.utc(normalizedStart).tz(userTimezone).format('YYYY-MM-DDTHH:mm');
                                const endLocal = dayjs.utc(normalizedEnd).tz(userTimezone).format('YYYY-MM-DDTHH:mm');

                                const startInput = document.getElementById('start_datetime');
                                const endInput = document.getElementById('end_datetime');
                                if (startInput) startInput.value = startLocal;
                                if (endInput) endInput.value = endLocal;
                            } catch (error) {
                                console.error('Error converting form times:', error, startUTC, endUTC);
                            }
                        }
                    <% } %>

                    // Handle form submission: convert local to UTC
                    const form = document.getElementById('eventForm');
                    form.addEventListener('submit', function (e) {
                        const startLocal = document.getElementById('start_datetime').value;
                        const endLocal = document.getElementById('end_datetime').value;

                        if (startLocal && endLocal && typeof dayjs !== 'undefined' && dayjs.tz) {
                            // Convert local time to UTC
                            const startUTC = dayjs.tz(startLocal, userTimezone).utc().format('YYYY-MM-DDTHH:mm:ss[Z]');
                            const endUTC = dayjs.tz(endLocal, userTimezone).utc().format('YYYY-MM-DDTHH:mm:ss[Z]');

                            // Set UTC values in hidden inputs
                            document.getElementById('start_datetime_utc').value = startUTC;
                            document.getElementById('end_datetime_utc').value = endUTC;

                            // Clear the local datetime inputs so backend receives UTC values
                            document.getElementById('start_datetime').name = '';
                            document.getElementById('end_datetime').name = '';

                            // Rename hidden inputs to the original names
                            document.getElementById('start_datetime_utc').name = 'start_datetime';
                            document.getElementById('end_datetime_utc').name = 'end_datetime';
                        }
                    });
                }

                // Wait for DOM and Day.js to be ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initDayJS);
                } else {
                    initDayJS();
                }

                const picker = document.getElementById("color");
                const preview = document.getElementById("colorPreview");

                if (preview) {
                    preview.style.backgroundColor = picker.value;

                    picker.addEventListener("input", () => {
                        preview.style.backgroundColor = picker.value;
                    });
                }

                // Recurring event functionality
                const recurringTypeSelect = document.getElementById('recurring_type');
                const recurringEndDateGroup = document.getElementById('recurring_end_date_group');
                const recurringEndDateInput = document.getElementById('recurring_end_date');
                const isEditMode = <%= isEditMode ? 'true' : 'false' %>;

                // Function to toggle recurring end date field visibility
                function toggleRecurringEndDate() {
                    const selectedValue = recurringTypeSelect.value;
                    if (selectedValue !== 'none') {
                        recurringEndDateGroup.style.display = 'block';
                        recurringEndDateInput.setAttribute('required', 'required');
                    } else {
                        recurringEndDateGroup.style.display = 'none';
                        recurringEndDateInput.removeAttribute('required');
                    }
                }

                // Initialize on page load (only if not in edit mode)
                if (!isEditMode) {
                    toggleRecurringEndDate();

                    // Listen for changes (only if not in edit mode)
                    recurringTypeSelect.addEventListener('change', toggleRecurringEndDate);
                } else {
                    // In edit mode, keep recurring end date group hidden
                    recurringEndDateGroup.style.display = 'none';
                }

                // Validate recurring end date when it's selected
                recurringEndDateInput.addEventListener('change', function () {
                    const startDatetime = document.getElementById('start_datetime').value;
                    const recurringEndDate = recurringEndDateInput.value;

                    if (recurringEndDate) {
                        // Check if start date is filled
                        if (!startDatetime) {
                            alert('Please fill in the Start Date & Time first');
                            recurringEndDateInput.value = '';
                            return;
                        }

                        // Extract date part from start_datetime (YYYY-MM-DD format)
                        const startDate = startDatetime.split('T')[0];

                        // Compare dates
                        if (new Date(recurringEndDate) < new Date(startDate)) {
                            alert('Recurring end date must be on or after the start date');
                            recurringEndDateInput.value = '';
                            return;
                        }
                    }
                });

                // Real-time conflict checking could be added here with AJAX
                const form = document.getElementById('eventForm');
                const submitButton = document.getElementById('submitButton');

                // Basic client-side validation
                form.addEventListener('submit', function (e) {
                    const start = document.getElementById('start_datetime').value;
                    const end = document.getElementById('end_datetime').value;

                    if (start && end && new Date(start) >= new Date(end)) {
                        e.preventDefault();
                        alert('End time must be after start time');
                        return false;
                    }

                    // Validate recurring end date if recurring is selected (only in create mode)
                    if (!isEditMode) {
                        const recurringType = recurringTypeSelect.value;
                        if (recurringType !== 'none') {
                            const recurringEndDate = recurringEndDateInput.value;
                            if (!recurringEndDate) {
                                e.preventDefault();
                                alert('Please select a recurring end date');
                                return false;
                            }
                        }
                    }
                });
            </script>

            <%- include('partials/footer') %>