<%
function getDaysInMonth(year, month) {
    return new Date(year, month + 1, 0).getDate();
}

function getFirstDayOfMonth(year, month) {
    return new Date(year, month, 1).getDay();
}

function formatDate(year, month, day) {
    const m = String(month + 1).padStart(2, '0');
    const d = String(day).padStart(2, '0');
    return `${year}-${m}-${d}`;
}

const daysInMonth = getDaysInMonth(year, month);
const firstDay = getFirstDayOfMonth(year, month);
const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

const eventsByDate = {};
if (typeof events !== 'undefined' && events !== null) {
    events.forEach(event => {
        try {
            const date = new Date(event.start_datetime)
                .toISOString()
                .split('T')[0];
            if (!eventsByDate[date]) eventsByDate[date] = [];
            eventsByDate[date].push(event);
        } catch (error) {
            console.error('Error processing event:', event, error);
        }
    });
}

Object.keys(eventsByDate).forEach(date => {
    eventsByDate[date].sort((a, b) => {
        return new Date(a.start_datetime) - new Date(b.start_datetime);
    });
});

const today = new Date().toISOString().split('T')[0];
%>

<%
const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
dayHeaders.forEach(day => { %>
    <div class="calendar-header"><%= day %></div>
<% }); %>

<% for (let i = 0; i < firstDay; i++) { %>
    <div class="calendar-day empty"></div>
<% } %>

<%
days.forEach(day => {
    const dateStr = formatDate(year, month, day);
    const dayEvents = eventsByDate[dateStr] || [];
    const isToday = dateStr === today;
%>

<div class="calendar-day <%= isToday ? 'today' : '' %>"
     data-date="<%= dateStr %>"
     onclick="loadDayView(this, '<%= dateStr %>')">

    <div class="day-header">
        <span class="day-number"><%= day %></span>
        <% if (dayEvents.length > 0) { %>
            <span class="event-count"><%= dayEvents.length %></span>
        <% } %>
    </div>

    <div class="day-events">
        <% if (dayEvents.length > 0) { %>
            <% dayEvents.forEach(event => {
                const start = new Date(event.start_datetime);
                const end = new Date(event.end_datetime);

                const startTime = start.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                const endTime = end.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                const eventColor = event.color || 'var(--greendale-blue-light)';
            %>
            <div class="mini-event" 
                 style="background: <%= eventColor %>;"
                 onclick="event.stopPropagation(); window.location.href='/event/<%= event.event_id %>'">
                <div class="mini-event-title"><%= event.event_name %></div>
                <div class="mini-event-time"><%= startTime %> - <%= endTime %></div>
            </div>
            <% }); %>
        <% } else { %>
            <div class="no-events">No events</div>
        <% } %>
    </div>
</div>
<% }); %>
