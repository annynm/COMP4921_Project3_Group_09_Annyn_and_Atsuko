<div class="day-view">
    <div class="time-grid" id="timeGrid">
        <% for (let hour = 0; hour < 24; hour++) { %>
            <%
            const hourStart = hour * 60;
            const halfHour = hourStart + 30;
            const quarter1 = hourStart + 15;
            const quarter2 = hourStart + 45;
            %>
            <div class="hour-slot" data-hour="<%= hour %>">
                <div class="hour-label"><%= hour.toString().padStart(2, '0') %>:00</div>
                <div class="half-hour" data-time="<%= quarter1 %>"></div>
                <div class="quarter-hour" data-time="<%= quarter1 %>"></div>
                <div class="quarter-hour" data-time="<%= quarter2 %>"></div>
            </div>
        <% } %>
    </div>
    
    <!-- Event Overlays -->
    <% if (typeof events !== 'undefined' && events.length > 0) { %>
        <% events.forEach(function(event) { %>
            <div class="event-overlay" 
                 data-utc-start="<%= event.start_datetime %>"
                 data-utc-end="<%= event.end_datetime %>"
                 data-color="<%= event.color || 'var(--greendale-blue)' %>"
                 data-event-id="<%= event.event_id %>"
                 data-event-name="<%= event.event_name %>"
                 data-room-name="<%= event.room_name || '' %>">
                <div class="event-overlay-name"><%= event.event_name %></div>
                <div class="event-overlay-time">Loading...</div>
                <% if (event.room_name) { %>
                    <div class="event-overlay-room"><%= event.room_name %></div>
                <% } %>
            </div>
        <% }); %>
    <% } %>
    
    <script>
        // Convert event times to local timezone and position events when Day.js is available
        function convertDayViewEventTimes() {
            if (typeof dayjs === 'undefined' || typeof dayjs_plugin_utc === 'undefined' || typeof dayjs_plugin_timezone === 'undefined') {
                setTimeout(convertDayViewEventTimes, 100);
                return;
            }
            
            dayjs.extend(dayjs_plugin_utc);
            dayjs.extend(dayjs_plugin_timezone);
            
            // Helper function to normalize UTC string to ISO format
            function normalizeUTCString(utcStr) {
                if (!utcStr) return null;
                
                // Convert to string if it's not already
                let str = String(utcStr).trim();
                
                // If it's already in ISO format with Z, return as-is
                if (str.endsWith('Z') && str.includes('T')) {
                    return str;
                }
                
                // Handle various formats
                // Replace space with T if present
                str = str.replace(' ', 'T');
                
                // Remove milliseconds if present
                str = str.replace(/\.\d{3}$/, '');
                
                // Ensure we have seconds
                if (!str.match(/T\d{2}:\d{2}:\d{2}/)) {
                    // Add :00 for seconds if missing
                    str = str.replace(/T(\d{2}:\d{2})$/, 'T$1:00');
                }
                
                // Add Z if not present
                if (!str.endsWith('Z')) {
                    str = str + 'Z';
                }
                
                return str;
            }
            
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            document.querySelectorAll('.event-overlay').forEach(function(overlay) {
                const utcStart = overlay.getAttribute('data-utc-start');
                const utcEnd = overlay.getAttribute('data-utc-end');
                const timeEl = overlay.querySelector('.event-overlay-time');
                
                if (utcStart && utcEnd) {
                    try {
                        const normalizedStart = normalizeUTCString(utcStart);
                        const normalizedEnd = normalizeUTCString(utcEnd);
                        const startLocal = dayjs.utc(normalizedStart).tz(userTimezone);
                        const endLocal = dayjs.utc(normalizedEnd).tz(userTimezone);
                        
                        // Update time display
                        if (timeEl) {
                            timeEl.textContent = startLocal.format('HH:mm') + ' - ' + endLocal.format('HH:mm');
                        }
                        
                        // Calculate position and size in local timezone
                        const startMinutes = startLocal.hour() * 60 + startLocal.minute();
                        const duration = endLocal.diff(startLocal, 'minute');
                        const top = (startMinutes / 60) * 60;
                        const height = (duration / 60) * 60;
                        
                        // Apply position and style
                        overlay.style.top = top + 'px';
                        overlay.style.height = height + 'px';
                        overlay.style.background = overlay.getAttribute('data-color');
                        overlay.onclick = function() {
                            window.location.href = '/event/' + overlay.getAttribute('data-event-id');
                        };
                    } catch (error) {
                        console.error('Error converting day view event time:', error, utcStart, utcEnd);
                    }
                }
            });
        }
        
        // Wait for DOM and Day.js to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', convertDayViewEventTimes);
        } else {
            convertDayViewEventTimes();
        }
    </script>
</div>
